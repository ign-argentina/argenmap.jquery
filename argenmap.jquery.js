/*!
 * argenmap.jquery v1
 * 
 * Version     : 1.5.1 (2014-12-12)
 * Licencia    : https://raw.github.com/IGNoficial/argenmap.jquery/master/LICENCIA
 * Web site    : http://www.ign.gob.ar/argenmap
 * Repositorio : http://github.com/IGNoficial/argenmap.jquery
 * Issues      : https://github.com/IGNoficial/argenmap.jquery/issues
 * Contacto    : argenmap@ign.gob.ar
 * 
 * Instituto Geografico Nacional de Argentina
 * Todos los derechos reservados.
 *
 */

!function(a){function 
b(b,d){this.element=b,this.$el=a(b),this.opts=a.extend({},c,d),this.gmap=null,this._marcadores={},this.capasWms=[],this.capasKml=[],this.infoMenuActivado=!1,this._dragging=!1}a.argenmap||(a.argenmap={}),a.argenmap.BASE_URL="http://static.ign.gob.ar/dist/",a.argenmap.IGN_CACHES=["http://wms.ign.gob.ar/geoserver/gwc/service/tms/1.0.0/capabaseargenmap@EPSG%3A3857@png"];var 
c={unit:"km",minZoom:1,zoom:5,mapTypeControl:!0,centro:{lat:-34,lng:-59},center:null};b.prototype={init:function(){var b=this;b.opts.center=new google.maps.LatLng(b.opts.centro.lat,b.opts.centro.lng),b.opts.streetViewControl=!1,b.opts.scaleControl=!0,b.opts.mapTypeControlOptions={style:google.maps.MapTypeControlStyle.DROPDOWN_MENU};var c=a.argenmap._crearDivParaElMapa(this.$el);return this.gmap=map=new google.maps.Map(c,b.opts),b.mapearEventosDelMapa(),this.$el.data("gmap",map),google.maps.event.addListener(map,"maptypeid_changed",function(){map.setZoom(map.getZoom()+1),map.setZoom(map.getZoom()-1)}),a.argenmap.GmapAgregarCapaBase(map,new a.argenmap.CapaBaseArgenmap),a.argenmap.GmapAgregarCapa(map,new a.argenmap.CapaTMSArgenmap),this.gmap.setMapTypeId("Mapa IGN"),!0},activarInfoMenu:function(){var b=this;this.infoMenuActivado!==!0&&(this.infoMenuActivado=!0,google.maps.event.addListener(map,"click",a.proxy(this.mostrarInfoMenu,this)),b.$el.find(".argenmapMapCanvas").on("mouseenter","a.argenmapFeatureInfo",function(){a(this).css({"background-color":"#1C74A5",color:"white"})}),b.$el.find(".argenmapMapCanvas").on("mouseleave","a.argenmapFeatureInfo",function(){a(this).css({"background-color":"transparent",color:"#1C74A5"})}),b.$el.find(".argenmapMapCanvas").on("click","a.argenmapFeatureInfo",a.proxy(this.pedirInformacion,this)))},desactivarInfoMenu:function(){google.maps.event.clearListeners(map,"click")},mostrarInfoMenu:function(a){var b=this.infoWindow();b.close();var c='<div id="infoMenu" style="width:200px;margin:0;padding:0">Lat/Long: <br /><strong>'+parseInt(1e4*a.latLng.lat(),10)/1e4+", "+parseInt(1e4*a.latLng.lng(),10)/1e4+'</strong></div><a style="color:#1C74A5;text-decoration:none;display:block;padding:3px;" data-y="'+a.pixel.y+'" data-x="'+a.pixel.x+'" data-maxwidth="'+parseInt(.6*this.$el.width(),10)+'" href="#" class="argenmapFeatureInfo">Obtener informaciÃ³n</a>';b.setOptions({position:a.latLng,maxWidth:500,content:c}),b.open(this.gmap)},pedirInformacion:function(b){var c=this,d=c.infoWindow();if(d.close(),b.preventDefault(),0===c.capasWms.length)return alert("No hay capas para consultar"),!1;var e=a('<div style="width:500px"  />'),f=parseInt(a(b.currentTarget).data("x"),10),g=parseInt(a(b.currentTarget).data("y"),10),h=c.gmap.getBounds().getSouthWest(),i=c.gmap.getBounds().getNorthEast(),j="1.1.1",k="GetFeatureInfo",l=({lat:i.lat(),lng:h.lng()},{lat:h.lat(),lng:i.lng()},"EPSG:4326"),m=h.lng()+","+h.lat()+","+i.lng()+","+i.lat(),n="WMS",o=c.$el.width(),p=c.$el.height(),q="";a.each(c.capasWms,function(a,b){if(b.consultable===!0){var c=b.url,d=b.capas,h=c+"SERVICE="+n+"&VERSION="+j+"&REQUEST="+k+"&LAYERS="+d+"&STYLES="+q+"&SRS="+l+"&BBOX="+m+"&WIDTH="+o+"&HEIGHT="+p+"&QUERY_LAYERS="+d+"&FEATURE_COUNT=50&X="+f+"&Y="+g+"&INFO_FORMAT=text/html",i='<p style="margin:0;padding:0;font-size:12px;line-height:12px;">Los datos a continuaciÃ³n son provistos por:<br /> <strong>'+c+'</strong><br /><a target="_otra" href="'+h+'">Abrir en otra ventana</a></p>';e.append(i),e.append('<iframe src="'+h+'" style="margin:0;padding:0;width:480px;display:block;border:none;" />'),e.append("<hr />")}}),d.setContent(a("<div>").append(e).html()),d.open(c.gmap)},mapearEventosDelMapa:function(){var a=this;google.maps.event.addListener(a.gmap,"zoom_changed",function(){a.$el.trigger("zoomend",a.gmap.getZoom()),a.$el.trigger("moveend",[a.gmap.getZoom(),a.$el.centro()])}),google.maps.event.addListener(a.gmap,"dragstart",function(){a._dragging=!0}),google.maps.event.addListener(a.gmap,"dragend",function(){a._dragging=!1,a.$el.trigger("moveend",[a.gmap.getZoom(),a.$el.centro()])}),google.maps.event.addListener(a.gmap,"center_changed",function(){a._dragging||a.$el.trigger("moveend",[a.gmap.getZoom(),a.$el.centro()])})},agregarCapaKML:function(b){var c=this,d={preserveViewport:!0,map:c.$el.data("gmap")};b=a.extend(d,b);var e=new google.maps.KmlLayer(b);this.capasKml.push(e)},infoWindow:function(b){return void 0===this._infoWindow&&(this._infoWindow=new google.maps.InfoWindow),this._infoWindow.setOptions(a.extend({},b)),this._infoWindow},agregarMarcador:function(b){var c=this,d={lat:c.gmap.getCenter().lat(),lng:c.gmap.getCenter().lng(),icono:a.argenmap.BASE_URL+"img/marcadores/punto.png",nombre:"Marcador_"+Math.floor(10100*Math.random()),contenido:void 0};b=a.extend({},d,b),b.hasOwnProperty("long")?b.lng=b["long"]:b.hasOwnProperty("lon")?b.lng=b.lon:b.hasOwnProperty("lat")&&"function"==typeof b.lat&&(b.lat=b.lat(),b.lng=b.lng());var e={};e.icon=b.icono,e.data=b.contenido,e.position=new google.maps.LatLng(b.lat,b.lng),e.title=b.nombre,e.map=c.gmap;var f=new google.maps.Marker(e);this._marcadores[b.nombre]=f,google.maps.event.addListener(f,"click",function(){b.contenido&&(c.infoWindow().close(),c.infoWindow().setContent(b.contenido),c.infoWindow().open(c.$el.data("gmap"),f))})},quitarMarcador:function(a){void 0!==this._marcadores[a]&&(this._marcadores[a].setMap(null),delete this._marcadores[a])},modificarMarcador:function(b,c){if(void 0!==this._marcadores[b]){var d=this._marcadores[b];this.quitarMarcador(b),c=a.extend(d,c),c.nombre=b,this.agregarMarcador(c)}},encuadrar:function(a){var b=this,c=a.sur,d=a.oeste,e=a.norte,f=(a.este,new google.maps.LatLng(c,d)),g=new google.maps.LatLng(e,d),h=new google.maps.LatLngBounds(f,g);b.gmap.fitBounds(h)},geocodificar:function(b,c){var d=this;a.getJSON("http://nominatim.openstreetmap.org/search?format=json&limit=5&q="+b,function(a){a.length&&c(a),console.log(a)},d)},quitarCapa:function(a){var b=this._traerCapaPorNombre(a);if(b)switch(b.tipo){case"wms":this.gmap.overlayMapTypes.removeAt(b.id,null),this.capasWms.splice(this.capasWms.indexOf(b.capa),1);break;case"kml":b.capa.setMap(null),this.capasKml.splice(this.capasKml.indexOf(b.capa),1)}},_traerCapaPorNombre:function(a){for(var b=this.gmap.overlayMapTypes.getArray(),c=0;c<b.length;c++)if(b[c].name==a)return{id:c,capa:b[c],tipo:"wms"};for(c=0;c<this.capasKml.length;c++)if(this.capasKml[c].nombre==a)return{id:c,capa:this.capasKml[c],tipo:"kml"};return null}},a.argenmap.CacheDeCliente=function(){this.MAX_TILES=150,this.cache=[],this.cacheRef={}},a.argenmap.CacheDeCliente.prototype={recuperar:function(b,c,d){var e=b+"-"+c+"-"+d;return-1!==a.inArray(e,this.cache)?this.cacheRef[e]:!1},guardar:function(a,b,c,d){if("string"!=typeof this.baseURL){var e=a+"-"+b+"-"+c;this.cache.push(e),this.cacheRef[e]=d;var f;this.cache.length>this.MAX_TILES&&(f=this.cache.shift(),delete this.cacheRef[f])}}},a.argenmap.CapaWMS=function(a){var b={imageMapType:null,gmap:null,tipo:"wms-1.1.1",url:"",capas:"",nombre:"Capa WMS",consultable:!0,crs:"EPSG:3857",transparente:!0};jQuery.extend(this,b,a);var c={alt:this.nombre,getTileUrl:jQuery.proxy(this.getTileUrl,this),isPng:!1,maxZoom:17,minZoom:1,name:this.nombre,tileSize:new google.maps.Size(256,256)};this.imageMapType=new google.maps.ImageMapType(c)},a.argenmap.CapaWMS.prototype={getTileUrl:function(b,c){var d=this.gmap.getProjection(),e=Math.pow(2,c),f=new google.maps.Point(256*b.x/e,256*(b.y+1)/e),g=new google.maps.Point(256*(b.x+1)/e,256*b.y/e),h=d.fromPointToLatLng(f),i=d.fromPointToLatLng(g),j=this.url,k="1.1.1",l="GetMap",m="image/png",n=this.capas;h=a.argenmap.latLngAMercator(h.lat(),h.lng()),i=a.argenmap.latLngAMercator(i.lat(),i.lng());var o=this.crs,p=h.lng+","+h.lat+","+i.lng+","+i.lat,q="256",r="256",s="",t=this.transparente?"TRUE":"FALSE",u=j+"VERSION="+k+"&SERVICE=WMS&REQUEST="+l+"&LAYERS="+n+"&STYLES="+s+"&SRS="+o+"&BBOX="+p+"&WIDTH="+q+"&HEIGHT="+r+"&FORMAT="+m+"&TRANSPARENT="+t;return u}},a.argenmap.CapaBaseWMS=function(b){var c={imageMapType:null,gmap:null,tipo:"wms-1.1.1",url:"",capas:"",nombre:"Capa base WMS",consultable:!0,crs:"EPSG:3857",transparente:!1};jQuery.extend(this,c,b);var d={alt:this.nombre,getTileUrl:jQuery.proxy(a.argenmap.CapaWMS.prototype.getTileUrl,this),isPng:!0,maxZoom:17,minZoom:1,name:this.nombre,tileSize:new google.maps.Size(256,256)};this.imageMapType=new google.maps.ImageMapType(d)},a.argenmap.CapaTMS=function(b){var c={cache:new a.argenmap.CacheDeCliente,imageMapType:null,gmap:null,tipo:"tms-1.0.0",nombre:"CAPA TMS",url:"",capas:""};jQuery.extend(this,c,b);var d={alt:this.nombre,getTileUrl:a.proxy(this.getTileUrl,this),isPng:!1,maxZoom:17,minZoom:1,name:this.nombre,tileSize:new google.maps.Size(256,256)};this.imageMapType=new google.maps.ImageMapType(d)},a.argenmap.CapaTMS.prototype={URL_HASH_FACTOR:(Math.sqrt(5)-1)/2,selectURL:function(a,b){var c,d,e=this,f=1;for(d=a.length,c=0,d;d>c;c++)f*=a.charCodeAt(c)*e.URL_HASH_FACTOR,f-=Math.floor(f);return b[Math.floor(f*b.length)]},getTileUrl:function(a,b){var c=this.url;if("string"!=typeof c){c=this.selectURL(a.x+""+a.y,c);var d=this.cache.recuperar(a.x,a.y,b);if(d)return d}var e=this.capas,f=(1<<b)-a.y-1,g=c+"/"+e+"/"+b+"/"+a.x+"/"+f+".png";return this.cache.guardar(a.x,a.y,b,g),g}},a.argenmap.CapaBaseArgenmap=function(){var b={nombre:"Mapa IGN",url:a.argenmap.IGN_CACHES,capas:"capabaseargenmap"};a.argenmap.CapaTMS.apply(this,[b])},a.argenmap.CapaBaseArgenmap.prototype=new a.argenmap.CapaTMS,a.argenmap.CapaBaseArgenmap.prototype.constructor=a.argenmap.CapaBaseArgenmap,a.argenmap.CapaTMSArgenmap=function(){var b={nombre:"IGN",url:a.argenmap.IGN_CACHES,capas:"capabasesigign"};a.argenmap.CapaTMS.apply(this,[b])},a.argenmap.CapaTMSArgenmap.prototype=new a.argenmap.CapaTMS,a.argenmap.CapaTMSArgenmap.prototype.constructor=a.argenmap.CapaTMSArgenmap,a.argenmap.CapaTMSArgenmap.prototype.getTileUrl=function(){return"satellite"!==this.gmap.getMapTypeId()?!1:a.argenmap.CapaTMS.prototype.getTileUrl.apply(this,arguments)},a.argenmap.GmapAgregarCapaBase=function(a,b){var c;b.gmap=a,a.mapTypes.set(b.imageMapType.name,b.imageMapType),a.mapTypeControlOptions?(c=a.mapTypeControlOptions.mapTypeIds,c?c.splice(0,0,b.imageMapType.name):c=[b.imageMapType.name,"satellite"]):c=[b.imageMapType.name,"satellite"],a.setOptions({mapTypeControlOptions:{mapTypeIds:c,style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}})},a.argenmap.GmapAgregarCapa=function(a,b){b.gmap=a,a.overlayMapTypes.push(b.imageMapType)},a.argenmap._crearDivParaElMapa=function(b){var c=a.argenmap.BASE_URL+"img/logoignsintexto-25px.png",d=a('<div class="argenmapMapCanvas" />').css({width:"100%","min-height":"200px"}),e=a('<div class="argenmapMapFooter" />').css({"font-family":"Arial","background-color":"#1C74A5","box-shadow":"0 0 11px rgb(5, 66, 100) inset","font-size":"10px","text-align":"right",height:"20px","vertical-align":"middle",color:"white","min-height":"15px","line-height":"15px",padding:"5px 5px",margin:0,border:0}),f=a("<img />").css({height:"20px"}),g=a('<a style="float:left" target="_blank" href="http://www.ign.gob.ar/argenmap/argenmap.jquery/docs"></a>').append(f),h=b;return f.attr("src",c).css({border:"0"}),h.append(d),h.append(e),e.append(g),e.append('<a style="color:white;text-decoration:underline;font-weight:normal" target="_blank" href="http://www.ign.gob.ar/argenmap/argenmap.jquery/docs/#datosvectoriales">Top&oacute;nimos, datos topogr&aacute;ficos - IGN Argentina // Calles - OpenStreetMap</a>'),a.argenmap._maximizarCanvas(h,e,d),d.get(0)},a.argenmap._maximizarCanvas=function(a,b,c){var d=a.innerHeight()-b.outerHeight();c.height(d),a.bind("resized",function(){var d=a.innerHeight()-b.outerHeight();c.height(d),google.maps.event.trigger(a.data().gmap,"resize")})},a.argenmap.latLngAMercator=function(a,b){var c=20037508.34*b/180,d=Math.log(Math.tan((90+a)*Math.PI/360))/(Math.PI/180);return d=20037508.34*d/180,{lat:d,lng:c}},a.event.special.resized={interval:0,setup:function(){var b=this,c=a(this),d=c.width(),e=c.height();a.event.special.resized.interval=setInterval(function(){(d!==c.width()||e!==c.height())&&(d=c.width(),e=c.height(),jQuery.event.dispatch.call(b,{type:"resized"}))},100)},teardown:function(){clearInterval(a.event.special.resized.interval)}},a.expr[":"].argenmap=function(b){return!!a.data(b,"argenmap")},a.fn.argenmap=function(c){var d=[];return a.each(this,function(){var d=a(this).data("argenmap");d||(d=new b(this,c),a(this).data("argenmap",d),d.init())}),d.length?1===d.length?d[0]:d:this},a.fn.agregarCapaBaseWMS=function(b){return this.each(function(){var c=a(this).data("argenmap");if(c){var d=a(this).data("gmap");c.activarInfoMenu();var e=new a.argenmap.CapaBaseWMS(b);c.capasWms.push(e),a.argenmap.GmapAgregarCapaBase(d,e)}})},a.fn.agregarCapaWMS=function(b){return this.each(function(){var c=a(this).data("argenmap");if(c){var d=a(this).data("gmap");c.activarInfoMenu();var e=new a.argenmap.CapaWMS(b);c.capasWms.push(e),a.argenmap.GmapAgregarCapa(d,e)}})},a.fn.agregarCapaBaseTMS=function(b){return this.each(function(){var c=a(this).data("argenmap");if(c){var d=a(this).data("gmap");a.argenmap.GmapAgregarCapaBase(d,new a.argenmap.CapaBaseTMS(b))}})},a.fn.agregarCapaTMS=function(b){return this.each(function(){var c=a(this).data("argenmap");if(c){var d=a(this).data("gmap");a.argenmap.GmapAgregarCapaTMS(d,new a.argenmap.CapaTMS(b))}})},a.fn.agregarCapaKML=function(b){return this.each(function(){var c=a(this).data("argenmap");c&&c.agregarCapaKML(b)})},a.fn.centro=function(b,c){if(0===arguments.length){if(!this.data("argenmap"))return[];var d=this.data("gmap").getCenter();return d?[d.lat(),d.lng()]:[]}return this.each(function(){var d=a(this).data("argenmap");d&&a(this).data("gmap").setCenter(new google.maps.LatLng(b,c))})},a.fn.zoom=function(b){if(void 0===b){if(!this.data("argenmap"))return null;var c=this.data("gmap").getZoom();return c?c:null}return this.each(function(){var c=a(this).data("argenmap");c&&a.isNumeric(b)&&a(this).data("gmap").setZoom(b)})},a.fn.capaBase=function(b){if(void 0===b){if(!this.data("argenmap"))return null;var c=this.data("gmap").mapTypeId;return c?c:null}return this.each(function(){var c=a(this).data("argenmap");c&&a(this).data("gmap").setMapTypeId(b)})},a.fn.agregarMarcador=function(b){return this.each(function(){var c=a(this).data("argenmap");c&&c.agregarMarcador(b)})},a.fn.quitarCapa=function(b){var c=b;return this.each(function(){if("string"==typeof c){var b=a(this).data("argenmap");b&&b.quitarCapa(c)}})},a.fn.agregarMarcadores=function(b){return this.each(function(){var c=this,d=a(this).data("argenmap");d&&a(b).each(function(b,d){a(c).agregarMarcador(d)})})},a.fn.quitarMarcador=function(b){var c=b;return this.each(function(){if("string"==typeof c){var b=a(this).data("argenmap");b&&b.quitarMarcador(c)}})},a.fn.modificarMarcador=function(b,c){var d=b,e=c;return this.each(function(){if("string"==typeof d&&void 0!==e&&"object"==typeof e){var b=a(this).data("argenmap");b&&b.modificarMarcador(d,e)}})},a.fn.encuadrar=function(b){return this.each(function(){a(this).data("argenmap");a(this).data("argenmap").encuadrar(b)})}}(jQuery);
